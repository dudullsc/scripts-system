#!/bin/bash

# --- Cores para os Logs ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO] $(date +'%T'): $1${NC}"
}
log_warn() {
    echo -e "${YELLOW}[AVISO] $(date +'%T'): $1${NC}"
}
log_error() {
    echo -e "${RED}[ERRO] $(date +'%T'): $1${NC}"
}

# --- 1. VerificaÃ§Ã£o de Root ---
if [ "$(id -u)" -ne 0 ]; then
  log_error "Este script precisa ser executado como root. Use: sudo ./instalar_agent_proxmox.sh"
  exit 1
fi

log_info "Iniciando a instalaÃ§Ã£o do Agente QEMU/Proxmox..."

# --- 2. InstalaÃ§Ã£o ---
log_info "Atualizando a lista de pacotes (apt update)..."
apt-get update > /dev/null

log_info "Instalando 'qemu-guest-agent'..."
apt-get install -y qemu-guest-agent

# --- 3. Habilitar ServiÃ§o ---
log_info "Iniciando e habilitando o serviÃ§o qemu-guest-agent..."
systemctl enable qemu-guest-agent
systemctl start qemu-guest-agent

log_info "Aguardando 2 segundos para o serviÃ§o estabilizar..."
sleep 2

# --- 4. VerificaÃ§Ã£o Final ---
if systemctl is-active --quiet qemu-guest-agent; then
    log_info "ðŸŽ‰ O Agente QEMU (Proxmox) estÃ¡ ATIVO e rodando!"
else
    log_error "O serviÃ§o qemu-guest-agent FALHOU ao iniciar."
    log_warn "Verifique os logs com: journalctl -xeu qemu-guest-agent"
    exit 1
fi

log_info "---------------------------------------------------------"
log_info "ðŸš¨ AÃ‡ÃƒO NECESSÃRIA NO SEU PROXMOX VE ðŸš¨"
log_info "A instalaÃ§Ã£o local estÃ¡ concluÃ­da. Agora vocÃª DEVE:"
log_info ""
log_info "1. Desligue esta VM."
log_info "2. No seu painel Proxmox, vÃ¡ para esta VM."
log_info "3. VÃ¡ em 'Options' -> 'QEMU Guest Agent'."
log_info "4. DÃª um duplo clique e marque a caixa 'Enabled'."
log_info "5. Inicie a VM novamente."
log_info ""
log_info "Seu Proxmox agora verÃ¡ o IP desta VM no 'Summary'."
log_info "---------------------------------------------------------"
